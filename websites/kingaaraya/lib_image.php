<?php//**************************************************************************************************// PeepShow (modified version on friday 1st of June 2007)// // Version		1.0// Function 	Web Photo Library// Author		Pierre-Emmanuel LŽvesque// Madein		Jogyakarta, Indonesia// Date 		April 9 2007//**************************************************************************************************// ************** GET THE CURRENT THEME ***************$filename = "_includes/theme_config";$handle = fopen($filename, "r");$theme = fread($handle, filesize($filename));fclose($handle);include('_themes/' . $theme . '/lib_image_config.inc'); // INCLUDE CONFIGURATION FILEinclude('_includes/lib_image_header.inc'); // INCLUDE HTML HEADER// **** SET THE REPLACED CHARACTERS IN THE ROLL NAMES ****$char_toreplace = array("_", "-", ".", "(a)");$char_original  = array(" ", "&#8217;" , "?", "&acirc;");//************************************// POSTED OR GET VARIABLES// retrieves - $mode, $roll, $photo//************************************// SET $MODE FROM A LINK OR A FORMif (isset($_POST['mode'])) $mode = $_POST['mode']; else $mode = $_GET['mode'];if ($mode == null) $mode = 'thumbnail';// SET $ROLL FROM A LINK OR A FORMif (isset($_POST['roll'])) $roll = $_POST['roll']; else $roll = $_GET['roll'];// SET $PHOTO FROM A LINK OR A FORMif (isset($_POST['photo'])) $photo = $_POST['photo']; else $photo = $_GET['photo'];//************************************// GET FOLDERS AND FILES// makes - $rolls[], $num_rolls, $photos[][], $num_photos[]//// !! TO-OPTIMIZE !! These two functions should only be calculated when the user enters the site the first time//************************************// MAKE ARRAY OF THE ROLLS AND COUNT THEM - !! with PHP5 use scandir !!$dh = opendir($fullsize_dir);$num_rolls = 0;while (false != ($file = readdir($dh))) { 	if ($file != "." && $file != ".." && $file != ".DS_Store") {		$rolls[] = $file;		$num_rolls++;	}}sort($rolls); // sort the rolls alphabetically// MAKE ARRAY OF THE PHOTOS AND COUNT THEMfor ($i = 0; $i < $num_rolls; $i++) {	$rolls_dir = $fullsize_dir . '/' . $rolls[$i];	$dh = opendir($rolls_dir);	$num_files = 0; // reset num_files	$j = 0; // photos counter	while (false != ($file = readdir($dh))) { 		if ($file != "." && $file != ".." && $file != ".DS_Store") {			$photos[$i][$j] = $file;			$num_files++;			$j++;			}	}	$num_photos[$i] = $num_files;	sort($photos[$i]); // sort the photos alphabetically}//************************************// THUMBNAIL MODE//************************************if ($mode == 'thumbnail') {		// MAIN DIV TAG (FOR THE WHOLE PAGE)	echo '<div id="peepshow_thumbnail_cont">';	// THUMBNAILS PAGE TITLE TEXT	echo '<p id="thumbnails_pagetitle">' .  $thumbnails_pagetitle . '</p>';		// ROLLS DROP-DOWN MENU	echo '<form id="rolls_menu" name="rollsmenu" action="">'; // make a form out the menu	echo '<select name="rollsmenu" onchange="location.href=\'lib_image.php?roll=\' + this.options[this.selectedIndex].value;">';	for ($i = 0; $i < $num_rolls; $i++) {		echo '<option value="' . $rolls[$i] . '"';		if ($_POST['roll'] == $rolls[$i] || $_GET['roll'] == $rolls[$i]) echo ' selected="selected"';		echo ' >' . str_replace($char_toreplace, $char_original, $rolls[$i]) . ' (' . $num_photos[$i] . ')' . '</option>';	}		echo '</select></form>';			// DISPLAY THUMBNAILS	if ($roll == null) $roll = $rolls[0];	$rolls_dir = $thumbnail_dir . '/' . $roll;	$i = 0; 	$j = 1; // counter for table <tr> tags	echo '<table cellpadding="5" cellspacing="5" border="0"><tr>';	$roll_key = array_search($roll, $rolls); // get roll number	for ($i = 0; $i < $num_photos[$roll_key]; $i++) {		echo '<td>';		if ($dropshadow == 1) echo '<div class="alpha-shadow"><div>'; // for dropshadows		echo '<a href="lib_image.php?mode=fullsize&amp;roll=' . $roll . '&amp;photo=' . $photos[$roll_key][$i] . '">';		echo '<img src="' . $rolls_dir . '/' . $photos[$roll_key][$i] . '" alt="' . $i . '" height="' . $thumbnail_height . 'px" />';		echo '</a>';		if ($dropshadow == 1) echo '</div></div>'; // for dropshadows		echo '</td>';			if (floor($j/$thumbnails_perline) == 1 ) { echo '</tr><tr>'; $j=0; }		$j++;	}	echo '<td></td></tr>'; // close <tr> tag if needed	echo '</table>';	// CLOSE CONTAINER	echo '</div>';	// FOOTER	echo '</body>';	echo '</html>';			} // close the main if statement for THUMBNAIL MODE//************************************// FULLSIZE MODE//************************************if ($mode == 'fullsize') {	// MAIN DIV TAG (FOR THE WHOLE PAGE)	echo '<div id="peepshow_fullsize_cont">';	// DIPLAY TITLE OF IMAGE, NUMBER OF IMAGES IN THE ROLL, ROLL TITLE AND LINK TO THUMBNAIL VIEW	if ($roll == null) $roll = $rolls[0]; // in case roll doesn't get passed	$roll_key = array_search($roll, $rolls); // get roll number	if ($photo == null) $photo = $photos[$roll_key][0]; // get name for 1st photo if null	$photo_key = array_search($photo, $photos[$roll_key]); // get photo number		echo '<p id="fullsize_toptext">';	echo '<span class="fullsize_rolltitles">'; echo $photo_key + 1; // 2 echoes needed to avoid bug	echo '<span class="fraction">' . $fraction . '</span>' . $num_photos[$roll_key] . '&nbsp;' . str_replace($char_toreplace, $char_original, $roll) . '</span>'; // closes fullsize_rolltitles	echo '<span class="fullsize_seperator">&nbsp;' . $seperator . '&nbsp;</span>';	echo '<span class="view_as_thumbnails"><a href="lib_image.php?mode=thumbnail&amp;roll=' . $roll . '">view as thumbnails</a></span>';	echo '</p>';			// DISPLAY FULLSIZE PHOTO	$rolls_dir = $fullsize_dir . '/' . $roll;	echo '<table border="0"><tr><td>'; // make a table to force center alignement	if ($dropshadow == 1) echo '<div class="alpha-shadow"><div>'; // for dropshadows	echo '<img src="' . $rolls_dir . '/' . $photo . '" alt="' . $photo . '" height="' . $fullsize_height . 'px" />';	if ($dropshadow == 1) echo '</div></div>'; // for dropshadows	echo '</td></tr></table>';		// DISPLAY PREVIOUS AND NEXT BUTTONS	echo '<p id="fullsize_buttons">';	if ($photo_key != 0) echo '<a href="lib_image.php?mode=fullsize&amp;roll=' . $roll . '&amp;photo=' . $photos[$roll_key][$photo_key - 1] . '" >';		else echo '<a href="lib_image.php?mode=fullsize&amp;roll=' . $roll . '&amp;photo=' . $photos[$roll_key][$num_photos[$roll_key] - 1] . '">';		echo '<span class="buttons">' . $prev_button . '</span>';	echo '</a> ';	if (($photo_key + 1) < $num_photos[$roll_key]) echo '<a href="lib_image.php?mode=fullsize&amp;roll=' . $roll . '&amp;photo=' . $photos[$roll_key][$photo_key + 1] . '" >';		else echo '<a href="lib_image.php?mode=fullsize&amp;roll=' . $roll . '&amp;photo=' . $photos[$roll_key][0] . '">';		echo '<span class="buttons">' . $next_button . '</span>';	echo '</a>';	echo '</p>';	// ROLLS DROP-DOWN MENU	echo '<form id="rolls_menu" name="rollsmenu" action="">'; // make a form out the menu	echo '<select name="rollsmenu" onchange="location.href=\'lib_image.php?mode=fullsize&amp;roll=\' + this.options[this.selectedIndex].value;">';	for ($i = 0; $i < $num_rolls; $i++) {		echo '<option value="' . $rolls[$i] . '"';		if ($_POST['roll'] == $rolls[$i] || $_GET['roll'] == $rolls[$i]) echo ' selected="selected"';		echo ' >' . str_replace($char_toreplace, $char_original, $rolls[$i]) . ' (' . $num_photos[$i] . ')' . '</option>';	}		echo '</select></form>';		// CLOSE THE MAIN DIV TAG	echo '</div>';	// FOOTER	echo '</body>';	echo '</html>';			} // close the main if statement for FULLZIDE MODE//************************************// END//************************************?>